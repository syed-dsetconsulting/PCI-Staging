name: Deploy to Staging

on:
  push:
    branches: [ main, develop, staging ]
  workflow_dispatch:

env:
  AZURE_CONTAINER_REGISTRY: pcistaging  # Replace with your actual ACR name
  CLUSTER_NAME: pci-staging-aks         # Replace with your actual AKS cluster name
  CLUSTER_RESOURCE_GROUP: PCI # Replace with your actual resource group name

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 9

    - name: Install Frontend Dependencies
      working-directory: ./PCI
      run: pnpm install --frozen-lockfile

    - name: Install Backend Dependencies
      working-directory: ./PCI-backend
      run: pnpm install --frozen-lockfile

    # Linting and testing disabled for now
    # - name: Lint Frontend
    #   working-directory: ./PCI
    #   run: pnpm run lint

    - name: Build Frontend
      working-directory: ./PCI
      run: pnpm run build
      env:
        SKIP_ENV_VALIDATION: true

    # - name: Test Backend
    #   working-directory: ./PCI-backend
    #   run: pnpm test

    - name: Build Backend
      working-directory: ./PCI-backend
      run: pnpm run build:dev

  build-and-push-staging:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Azure CLI Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Pre-pull base images\n      run: |\n        docker pull node:18-alpine || true\n\n    - name: Set up Docker
      uses: docker/setup-buildx-action@v3

    - name: Login to Azure Container Registry with Azure CLI
      run: |
        az acr login --name ${{ env.AZURE_CONTAINER_REGISTRY }}

    - name: Build and push Frontend image with Docker
      run: |
        retry() { for i in 1 2 3; do  $@ && break || { echo Retry /3; sleep 5; }; done; };\n        retry docker build -t ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/pci-frontend:staging-latest -f ./PCI/Dockerfile ./PCI
        retry docker push ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/pci-frontend:staging-latest

    - name: Build and push Backend image with Docker
      run: |
        retry() { for i in 1 2 3; do  $@ && break || { echo Retry /3; sleep 5; }; done; };\n        retry docker build -t ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/pci-backend:staging-latest -f ./PCI-backend/Dockerfile ./PCI-backend
        retry docker push ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/pci-backend:staging-latest

  deploy-staging:
    needs: build-and-push-staging
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
    - uses: actions/checkout@v4

    - name: Azure CLI Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: "3.12.0"

    - name: Get AKS credentials
      run: |
        az aks get-credentials --resource-group ${{ env.CLUSTER_RESOURCE_GROUP }} --name ${{ env.CLUSTER_NAME }}

    - name: Install NGINX Ingress Controller
      run: |
        if ! kubectl get namespace ingress-nginx >/dev/null 2>&1; then
          echo "Installing NGINX Ingress Controller..."
          kubectl create namespace ingress-nginx
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo update
          helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
            --namespace ingress-nginx \
            --wait --timeout=10m
        fi

    - name: Deploy Application to Staging
      run: |
        helm upgrade --install pci-app-staging ./helm/pci-app \
          --namespace pci-app-staging \
          --create-namespace \
          --set global.namespace=pci-app-staging \
          --set frontend.image.repository=${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/pci-frontend \
          --set frontend.image.tag=staging-latest \
          --set backend.image.repository=${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/pci-backend \
          --set backend.image.tag=staging-latest \
          --set database.auth.password=${{ secrets.DB_PASSWORD_STAGING }} \
          --set frontend.replicaCount=1 \
          --set backend.replicaCount=1 \
          --wait --timeout=15m

    - name: Get External IP and Verify Deployment
      run: |
        echo " Staging Deployment Summary"
        echo "================================"
        
        # Wait for external IP
        echo "Waiting for external IP..."
        sleep 60
        EXTERNAL_IP=$(kubectl get service -n ingress-nginx ingress-nginx-controller -o jsonpath="{.status.loadBalancer.ingress[0].ip}")
        echo "External IP: $EXTERNAL_IP"
        
        echo " Pods Status:"
        kubectl get pods -n pci-app-staging
        
        echo " Services:"
        kubectl get services -n pci-app-staging
        
        echo " Staging application available at: http://$EXTERNAL_IP"
